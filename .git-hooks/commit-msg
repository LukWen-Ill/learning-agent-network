#!/usr/bin/env bash
# commit-msg hook for Slow LLM Coding Agent
# Validates commit message format

commit_msg_file=$1
commit_msg=$(cat "$commit_msg_file")

# Extract first line
first_line=$(head -n 1 "$commit_msg_file")

# Valid commit types
valid_types="feat|fix|docs|refactor|test|chore|style|perf|hotfix"

# Regex pattern: type(optional-scope): description
# or: type: description
pattern="^($valid_types)(\([a-z0-9-]+\))?: .+"

if [[ ! $first_line =~ $pattern ]]; then
  echo "❌ ERROR: Invalid commit message format"
  echo ""
  echo "Expected format:"
  echo "  type(scope): description"
  echo "  or"
  echo "  type: description"
  echo ""
  echo "Valid types: feat, fix, docs, refactor, test, chore, style, perf, hotfix"
  echo ""
  echo "Examples:"
  echo "  feat(calculator): add basic arithmetic operations"
  echo "  fix(navigation): prevent overflow on last state"
  echo "  docs: update installation guide"
  echo ""
  echo "Your commit message:"
  echo "  $first_line"
  echo ""
  exit 1
fi

# Check description length (after 'type(scope): ')
description=$(echo "$first_line" | sed -E "s/^($valid_types)(\([a-z0-9-]+\))?: //")
desc_length=${#description}

if [ $desc_length -gt 72 ]; then
  echo "⚠️  WARNING: Commit description is $desc_length characters (max 72 recommended)"
  echo "  Consider shortening: $description"
  echo ""
  # Warning only, don't exit
fi

# Check if description starts with lowercase
first_char=$(echo "$description" | head -c 1)
if [[ ! $first_char =~ [a-z] ]]; then
  echo "⚠️  WARNING: Description should start with lowercase letter"
  echo "  '$description'"
  # Warning only, don't exit
fi

# Check if description ends with period
if [[ $description =~ \.\s*$ ]]; then
  echo "⚠️  WARNING: Description should not end with a period"
  echo "  '$description'"
  # Warning only, don't exit
fi

# Success
echo "✓ Commit message format valid"
exit 0
